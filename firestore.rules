/**
 * FIRESTORE SECURITY RULES
 * 
 * CORE PHILOSOPHY
 * This ruleset implements a robust Role-Based Access Control (RBAC) model designed for a salon management 
 * ecosystem. It strictly separates internal management data (accessible only to administrators) from 
 * public-facing content (viewable by anyone). 
 * 
 * DATA STRUCTURE
 * The database is organized into top-level collections:
 * 1. RBAC Control: `/roles_admin` defines who has administrative privileges.
 * 2. Internal Management: `/products`, `/services`, `/staffMembers`, `/customers`, `/bookings`, `/expenses`.
 *    These contain the "source of truth" and sensitive data.
 * 3. Public Mirrors: `/public_products`, `/public_services`, `/public_staff_profiles`.
 *    These contain denormalized, redacted copies of items intended for the public website.
 * 
 * KEY SECURITY DECISIONS
 * - Authorization Independence via Denormalization: To solve the "public pages not updating" issue, 
 *   visibility is controlled by the physical presence of a document in a "public_" collection. 
 *   If it's in the public collection, it is readable by the world.
 * - DBAC (Database-Based Access Control): Administrative status is determined by the existence of 
 *   a document in the `/roles_admin` collection where the document ID matches the user's UID.
 * - Strict Write Protection: No write operations (create, update, delete) are permitted for 
 *   non-authenticated or non-admin users across any collection.
 * 
 * PROTOTYPING NOTE:
 * For initial prototyping, isAdmin() is simplified to check only if a user is signed in.
 * In a production environment, uncomment the 'exists' check to restrict access to specific UIDs.
 */

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---

    /**
     * @description Checks if the request is from a signed-in user.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Verifies if the authenticated user has administrative privileges.
     * Simplified for prototyping to allow any signed-in user.
     */
    function isAdmin() {
      return isSignedIn();
      // return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Checks if the provided UID matches the authenticated user's UID.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Combines admin check with existence check for updates and deletes.
     */
    function isExistingAdmin() {
      return isAdmin() && resource != null;
    }

    // --- COLLECTION RULES ---

    match /roles_admin/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create, update, delete: if isAdmin();
    }

    match /products/{productId} {
      allow get, list: if isAdmin();
      allow create: if isAdmin();
      allow update, delete: if isExistingAdmin();
    }

    match /public_products/{productId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update, delete: if isExistingAdmin();
    }

    match /services/{serviceId} {
      allow get, list: if isAdmin();
      allow create: if isAdmin();
      allow update, delete: if isExistingAdmin();
    }

    match /public_services/{serviceId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update, delete: if isExistingAdmin();
    }

    match /staffMembers/{staffId} {
      allow get, list: if isAdmin();
      allow create: if isAdmin();
      allow update, delete: if isExistingAdmin();
    }

    match /public_staff_profiles/{staffId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update, delete: if isExistingAdmin();
    }

    match /customers/{customerId} {
      allow get, list: if isAdmin();
      allow create: if isAdmin();
      allow update, delete: if isExistingAdmin();
    }

    match /bookings/{bookingId} {
      allow get, list: if isAdmin();
      allow create: if isAdmin();
      allow update, delete: if isExistingAdmin();
    }

    match /expenses/{expenseId} {
      allow get, list: if isAdmin();
      allow create: if isAdmin();
      allow update, delete: if isExistingAdmin();
    }
  }
}